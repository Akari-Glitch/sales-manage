extends ../templates/template


block main
	a(href="/index" class="btn-back") Volver
	div(class="contain-inv")
		button(onClick="showForm()" class="btn-buy") Realizar una nueva compra
		input(type="number" id="tasa-dolar" placeholder="Ingrese tasa del d√≥lar actual..." name="tasa-dolar" step="0.01")

		div(id="form-contain" class="form-contain-inv")
			form(action="/inventario/add" method="POST" class="form-inv" id="form")

				div(class="form-content")
					div(id="content-inputs" class="content-inputs")
						input(id="client" autocomplete="off" type="text" name="client" placeholder="nombre del cliente")
						div(class="camps")
							span(class="articulo-camp") Articulo
							span(class="mount-camp") Cantidad
							span(class="priceDolar-camp") Precio $
							span(class="priceBs-camp") Precio Bs
							span(class="totalDolar-camp") Monto $
							span(class="totalBs-camp") Monto Bs
						div(id="content-articles" class="content-articles")
					
					div(class="input-total")
						input(class="total-dolar" id="monto-total-dolar" step="0.01" type="number" name="priceTotalAllDolar" placeholder="total $" readonly)
						input(class="total-bs" id="monto-total-bs" step="0.01" type="number" name="priceTotalAllBs" placeholder="total Bs" readonly) 
	
					div(class="content-btn")
						button(type="button" onClick="addNewArticle()") agregar nuevo articulo
						button(type="submit") Realizar venta
						button(type="button" onClick="hiddenForm()") Cancelar
						
	div(class="contain-sells")
		h1(class="title-sells") Ventas:
		ul(class="list-sales")
			each sale in sales.reverse()
				a(href="/edit/"+sale.id class="sale-contain-link")
					li(id=sale.id class="sale-contain")
						div(class="products-contain")
							p(class="sale-client")= sale.client
									each items, index in sale.product
										p(class="sale-product")= "- "+items 
											span(class="amount")= "("+sale.amount[index]+")"
						p(class="total-dolar")= "total $: "+ sale.priceTotalAllDolar
						p(class="total-bs")= "total bs: "+ sale.priceTotalAllBs
						-var fecha = sale.createdAt
						p(class="fecha" id="fecha") #{String(fecha).slice(0,16)}
							   
	script.
		const formContain = document.getElementById("form-contain")
		const form = document.getElementById('form')
		const inputs = document.getElementById('content-articles')
		const tasaDolar = document.getElementById('tasa-dolar')
		const montoTotalDolar = document.getElementById("monto-total-dolar")
		const montoTotalBs = document.getElementById('monto-total-bs')
		let bs;
		let count = 1;

		formContain.style.display = 'none'
		
		inputs.innerHTML = 
				`
				<div class="article">
				<span>${count}#</span>
				<input id="article${count}"" type="text" name="product" placeholder="nombre del articulo">
				</input>
				<input id="mount${count}" type="number" name="amount" oninput="changeMount(this)" placeholder="cantidad de articulos"></input>
				<input id="price${count}" step="0.01" oninput="converToBs(this)" type="number" name="priceDolar" placeholder="precio $"></input>
				<input id="priceBs${count}" step="0.01" type="number" name="priceBs" placeholder="precio bs" readonly>
				<input id="priceTotalDolar${count}" step="0.01" type="number" name="priceTotalDolar" placeholder="monto $" readonly>
				<input id="priceTotalBs${count}" step="0.01" type="number" name="priceTotalBs" placeholder="monto Bs" readonly>
				
				</div>
				`

		function addNewArticle(){
			count++;
			let div = document.createElement('div');
			div.setAttribute('class', 'article')
				div.innerHTML = `
				<div class="article">	
				<span>${count}#</span>
				<input id="article${count}"" type="text" name="product" placeholder="nombre del articulo">
				</input>
				<input id="mount${count}" oninput="changeMount(this)" type="number" name="amount" placeholder="cantidad de articulos"></input>
				<input id="price${count}" step="0.01" type="number" oninput="converToBs(this)" name="priceDolar" placeholder="precio $"></input>
				<input id="priceBs${count}" step="0.01" type="number" name="priceBs" placeholder="monto bs" readonly>
				<input id="priceTotalDolar${count}" step="0.01" type="number" name="priceTotalDolar" placeholder="total $" readonly>
				<input id="priceTotalBs${count}" step="0.01" type="number" name="priceTotalBs" placeholder="monto Bs" readonly>

					<button onClick="removeArticle(this)" class="btn-delete-art">eliminar</button>
				</div>	
					`


				inputs.appendChild(div)
			
		}



		function removeArticle(e){
			count--
			e.parentElement.remove()
			changeTotal()
		}

		function showForm(){
			if(formContain.style.display === 'none'){
				formContain.style.display = 'block'
			}
		}

		function hiddenForm(){
			if(formContain.style.display === 'block'){
				formContain.style.display = 'none'
			}
		}

		function changeTotal(){
			let count = 1;
			let suma = 0;
		
			do{
				let input = document.getElementById(`priceTotalDolar${count}`)
				if(input == null){
					count = -2
				}else{
				suma = Number(suma) + Number(input.value)

				}
				
				count++;
			}
			while(count > -1)
			
			montoTotalDolar.value = suma.toFixed(2);
			montoTotalBs.value = (montoTotalDolar.value * tasaDolar.value).toFixed(2)
		}

		function converToBs(e){
			const getCount = e.id.slice(5)
			const mount = document.getElementById(`mount${getCount}`)
			const priceBs = document.getElementById(`priceBs${getCount}`)
			const priceTotalBs = document.getElementById(`priceTotalBs${getCount}`)
			const priceTotalDolar = document.getElementById(`priceTotalDolar${getCount}`)
			const priceDolar = document.getElementById(`price${getCount}`)

			priceBs.value =  (tasaDolar.value*e.value).toFixed(2)
			priceTotalBs.value = ((tasaDolar.value * e.value) * mount.value).toFixed(2)
			priceTotalDolar.value = (priceDolar.value * mount.value).toFixed(2)  
			changeTotal()
		}


		function changeMount(e){
			const getCount = e.id.slice(5)
			const priceDolar = document.getElementById(`price${getCount}`)
			converToBs(priceDolar)
		}

